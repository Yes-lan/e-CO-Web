{% extends 'base.html.twig' %}

{% block title %}G√©rer les Parcours - e-CO{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('assets/css/style.css') }}">
{% endblock %}

{% block body %}
<div class="manage-container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>üóÇÔ∏è G√©rer les Parcours</h1>
            <p>Modifiez, visualisez les QR codes et g√©rez vos parcours d'orientation</p>
        </div>
        <div>
            <a href="{{ path('app_home') }}" class="btn btn-secondary">üè† Accueil</a>
        </div>
    </div>

    <div class="course-list" id="courseList">
        <p style="text-align: center; color: #666;">Chargement des parcours...</p>
    </div>
</div>

<!-- Edit Course Modal -->
<div id="editCourseModal" class="modal">
    <div class="modal-content modal-large">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2 id="modalTitle">Modifier le Parcours</h2>
        
        <div id="editCourseContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<!-- QR Codes Modal -->
<div id="qrCodesModal" class="modal">
    <div class="modal-content modal-large">
        <span class="close" onclick="closeQRModal()">&times;</span>
        <h2>üî≤ QR Codes du Parcours</h2>
        
        <!-- Important information about QR code stability -->
        <div style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
            <p style="margin: 0; color: #0c5460; font-weight: 600;">
                ‚ÑπÔ∏è <strong>Important :</strong> Ces QR codes sont <strong>permanents et ne changent jamais</strong> pour ce parcours.
            </p>
            <p style="margin: 0.5rem 0 0 0; color: #0c5460; font-size: 0.9rem;">
                Vous pouvez les imprimer et les placer sur le terrain en toute s√©curit√©. Ils resteront valides m√™me si vous consultez cette page plusieurs fois.
            </p>
        </div>
        
        <div style="text-align: right; margin-bottom: 1rem;">
            <button class="btn btn-primary" onclick="downloadAllQRCodes()">üì• T√©l√©charger tout (PDF)</button>
        </div>
        <div id="qrCodesContent" class="qr-codes-grid">
            <!-- QR codes loaded dynamically -->
        </div>
    </div>
</div>

{% block javascripts %}
    {{ parent() }}
    
    <script>
        // Use window object to prevent redeclaration errors with Turbo
        if (!window.manageCoursePageInitialized) {
            window.manageCoursePageInitialized = true;
            window.manageCourses = [];
            window.currentEditingCourse = null;
            window.editBoundaryMap = null;
            window.qrCodeLibraryLoaded = false;
            window.jspdfLibraryLoaded = false;
        }

        // Cleanup function for Turbo navigation
        document.addEventListener('turbo:before-visit', function() {
            if (window.editBoundaryMap) {
                window.editBoundaryMap = null;
            }
        });

        // Load courses immediately
        async function initManagePage() {
            await loadCourses();
        }

        document.addEventListener('DOMContentLoaded', initManagePage);
        document.addEventListener('turbo:load', initManagePage);

        async function loadCourses() {
            try {
                const response = await fetch(`/assets/data/courses.json?t=${Date.now()}`);
                const data = await response.json();
                window.manageCourses = data.courses || [];
                displayCourses();
            } catch (error) {
                console.error('Error loading courses:', error);
                document.getElementById('courseList').innerHTML = '<p style="color: #d32f2f; text-align: center;">Erreur de chargement des parcours</p>';
            }
        }

        function displayCourses() {
            const container = document.getElementById('courseList');
            
            if (window.manageCourses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Aucun parcours disponible. <a href="{{ path('app_course_create') }}">Cr√©er un parcours</a></p>';
                return;
            }

            container.innerHTML = window.manageCourses.map((course, index) => {
                const waypointCount = course.waypoints ? course.waypoints.length : 0;
                const hasCoordinates = course.waypoints && course.waypoints.some(wp => wp.lat != null && wp.lng != null);
                const hasBoundaries = course.boundaryPoints && course.boundaryPoints.length >= 3;
                
                return `
                    <div class="course-card">
                        <div class="course-info">
                            <h3>${course.name || 'Sans nom'}</h3>
                            <div class="course-meta">
                                <span>üéØ ${waypointCount} balise(s)</span>
                                <span>${hasCoordinates ? 'üìç Coordonn√©es' : '‚ö†Ô∏è Pas de coordonn√©es'}</span>
                                <span>${hasBoundaries ? 'üó∫Ô∏è Limites d√©finies' : '‚ùå Pas de limites'}</span>
                                <span>üìÖ ${new Date(course.createdAt).toLocaleDateString('fr-FR')}</span>
                            </div>
                        </div>
                        <div class="course-actions">
                            <button class="btn btn-info btn-small" onclick="editCourse(${index})">‚úèÔ∏è Modifier</button>
                            <button class="btn btn-success btn-small" onclick="viewQRCodes(${index})">üî≤ QR Codes</button>
                            <button class="btn btn-danger btn-small" onclick="deleteCourse(${index})">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editCourse(index) {
            window.currentEditingCourse = { ...window.manageCourses[index], index };
            showEditModal();
        }

        function showEditModal() {
            const modal = document.getElementById('editCourseModal');
            const content = document.getElementById('editCourseContent');
            
            const course = window.currentEditingCourse;
            
            content.innerHTML = `
                <form id="editCourseForm" onsubmit="saveCourseChanges(event)">
                    <!-- Basic Info -->
                    <div class="edit-section">
                        <h3>üìã Informations G√©n√©rales</h3>
                        <div class="form-group">
                            <label>Nom du parcours:</label>
                            <input type="text" id="editCourseName" value="${course.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label>Description:</label>
                            <textarea id="editCourseDescription">${course.description || ''}</textarea>
                        </div>
                    </div>

                    <!-- Boundaries -->
                    <div class="edit-section">
                        <h3>üó∫Ô∏è Limites du Parcours</h3>
                        <p style="font-size: 0.9rem; color: #666;">
                            ${course.boundaryPoints && course.boundaryPoints.length >= 3 
                                ? `${course.boundaryPoints.length} points de limite d√©finis` 
                                : 'Aucune limite d√©finie'}
                        </p>
                        <div class="boundary-mini-map" id="editBoundaryMap"></div>
                        <div style="margin-top: 1rem;">
                            <button type="button" class="btn btn-secondary btn-small" onclick="clearBoundaries()">üóëÔ∏è Effacer les limites</button>
                        </div>
                    </div>

                    <!-- Waypoints -->
                    <div class="edit-section">
                        <h3>üéØ Balises</h3>
                        <div id="editWaypointsList">
                            ${renderWaypointsList(course)}
                        </div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addWaypoint()">‚ûï Ajouter une balise</button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
                        <button type="submit" class="btn btn-success">‚úÖ Enregistrer les modifications</button>
                    </div>
                </form>
            `;
            
            modal.style.display = 'block';
            
            // Initialize boundary map after modal is shown
            setTimeout(initEditBoundaryMap, 500);
        }

        function renderWaypointsList(course) {
            if (!course.waypoints || course.waypoints.length === 0) {
                return '<p style="color: #666;">Aucune balise</p>';
            }
            
            return course.waypoints.map((wp, idx) => `
                <div class="waypoint-list-item" data-waypoint-index="${idx}">
                    <div>
                        <strong>Balise ${wp.id || idx + 1}:</strong> ${wp.name || 'Sans nom'}
                        <br>
                        <small style="color: #666;">${wp.lat != null ? `üìç ${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}` : '‚ö†Ô∏è Pas de coordonn√©es'}</small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-warning btn-small" onclick="editWaypoint(${idx})">‚úèÔ∏è</button>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeWaypoint(${idx})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function initEditBoundaryMap() {
            const mapElement = document.getElementById('editBoundaryMap');
            if (!mapElement || window.editBoundaryMap) return;

            const course = window.currentEditingCourse;
            const center = course.boundaryPoints && course.boundaryPoints.length > 0 
                ? { lat: course.boundaryPoints[0].lat, lng: course.boundaryPoints[0].lng }
                : { lat: 45.828, lng: 1.256 };

            window.editBoundaryMap = new google.maps.Map(mapElement, {
                center: center,
                zoom: 15,
                mapTypeId: 'hybrid',
                tilt: 0,
                rotateControl: false,
                styles: [
                    { featureType: "poi", stylers: [{ visibility: "off" }] }
                ]
            });

            // Display existing boundaries
            if (course.boundaryPoints && course.boundaryPoints.length >= 3) {
                const path = course.boundaryPoints.map(p => ({ lat: p.lat, lng: p.lng }));
                new google.maps.Polygon({
                    paths: path,
                    strokeColor: '#667eea',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#667eea',
                    fillOpacity: 0.2,
                    map: window.editBoundaryMap
                });

                // Fit bounds
                const bounds = new google.maps.LatLngBounds();
                course.boundaryPoints.forEach(p => bounds.extend({ lat: p.lat, lng: p.lng }));
                window.editBoundaryMap.fitBounds(bounds);
            }
        }

        function addWaypoint() {
            const course = window.currentEditingCourse;
            
            // Generate unique ID for new waypoint (find highest ID + 1)
            let maxId = 0;
            if (course.waypoints && course.waypoints.length > 0) {
                maxId = Math.max(...course.waypoints.map(wp => wp.id || 0));
            }
            const newId = maxId + 1;
            
            // Create new waypoint with unique ID
            const newWaypoint = {
                id: newId,  // PERMANENT unique ID - never changes!
                name: `Nouvelle balise ${newId}`,
                description: '',
                lat: null,
                lng: null,
                type: 'control'
            };
            
            // Add to waypoints array
            if (!course.waypoints) {
                course.waypoints = [];
            }
            course.waypoints.push(newWaypoint);
            
            // Refresh the waypoints list
            document.getElementById('editWaypointsList').innerHTML = renderWaypointsList(course);
            
            // Show important warning
            alert('‚ö†Ô∏è IMPORTANT: Nouvelle balise ajout√©e!\n\n' +
                  'Cette balise a un nouveau QR code qui n\'existait pas avant.\n' +
                  'Vous devez:\n' +
                  '1. Consulter les QR codes mis √† jour\n' +
                  '2. Imprimer UNIQUEMENT le nouveau QR code (Balise ' + newId + ')\n' +
                  '3. Placer ce nouveau QR code sur le terrain\n\n' +
                  'Les autres QR codes restent inchang√©s!');
        }

        function editWaypoint(index) {
            alert(`Modifier balise ${index + 1}`);
        }

        function removeWaypoint(index) {
            if (confirm(`Supprimer la balise ${index + 1} ?`)) {
                window.currentEditingCourse.waypoints.splice(index, 1);
                document.getElementById('editWaypointsList').innerHTML = renderWaypointsList(window.currentEditingCourse);
            }
        }

        function clearBoundaries() {
            if (confirm('Effacer toutes les limites du parcours ?')) {
                window.currentEditingCourse.boundaryPoints = null;
                if (window.editBoundaryMap) {
                    // Reinitialize map
                    window.editBoundaryMap = null;
                    initEditBoundaryMap();
                }
            }
        }

        async function saveCourseChanges(event) {
            event.preventDefault();
            
            // Update course data
            window.currentEditingCourse.name = document.getElementById('editCourseName').value;
            window.currentEditingCourse.description = document.getElementById('editCourseDescription').value;
            
            // Update in courses array
            window.manageCourses[window.currentEditingCourse.index] = window.currentEditingCourse;
            
            // Save to backend (would need API endpoint)
            alert('Modifications enregistr√©es ! (Impl√©mentation API n√©cessaire)');
            closeEditModal();
            displayCourses();
        }

        function closeEditModal() {
            document.getElementById('editCourseModal').style.display = 'none';
            window.editBoundaryMap = null;
            window.currentEditingCourse = null;
        }

        async function viewQRCodes(index) {
            const course = window.manageCourses[index];
            const modal = document.getElementById('qrCodesModal');
            const content = document.getElementById('qrCodesContent');
            
            // Check if course has been modified (compare waypoint count)
            const waypointCount = course.waypoints ? course.waypoints.length : 0;
            const previousWaypointCount = course.initialWaypointCount || waypointCount;
            
            if (waypointCount !== previousWaypointCount) {
                const diff = waypointCount - previousWaypointCount;
                const message = diff > 0 
                    ? `‚ö†Ô∏è ATTENTION: ${diff} balise(s) ont √©t√© ajout√©es depuis la cr√©ation.\n\nVous verrez de NOUVEAUX QR codes pour ces balises.\nLes QR codes existants restent inchang√©s.`
                    : `‚ö†Ô∏è ATTENTION: ${Math.abs(diff)} balise(s) ont √©t√© supprim√©es.\n\nCertains QR codes ne sont plus pr√©sents dans la liste.\nNe les r√©imprimez pas!`;
                
                alert(message);
            }
            
            content.innerHTML = '<p style="text-align: center;">G√©n√©ration des QR codes...</p>';
            modal.style.display = 'block';
            
            setTimeout(() => generateQRCodes(course), 100);
        }

        function generateQRCodes(course, retryCount = 0) {
            // Check if QRCode library is loaded
            if (typeof QRCode === 'undefined') {
                if (retryCount > 50) {
                    document.getElementById('qrCodesContent').innerHTML = '<p style="color: #d32f2f; text-align: center;">Erreur: Impossible de charger la biblioth√®que QR Code. Veuillez recharger la page.</p>';
                    return;
                }
                console.log('QRCode library not loaded yet, retrying... (' + retryCount + ')');
                setTimeout(() => generateQRCodes(course, retryCount + 1), 300);
                return;
            }
            
            console.log('QRCode library loaded! Generating codes...');
            const content = document.getElementById('qrCodesContent');
            const qrCodes = [];

            // IMPORTANT: Use course creation timestamp (fixed) instead of current time
            // This ensures QR codes are STABLE and don't change when viewed multiple times
            const courseTimestamp = course.created_at || course.id;

            // Start Point - START QR Code
            const startQRData = {
                type: 'START_COURSE',
                courseId: course.id,
                courseName: course.name,
                pointName: course.startPoint?.name || 'Depart',
                courseCreated: courseTimestamp  // FIXED timestamp from course creation
            };
            qrCodes.push({
                label: `DEPART - DEBUT DU PARCOURS`,
                displayLabel: `Depart - DEBUT`,
                data: JSON.stringify(startQRData),
                color: '#000000'
            });

            // Waypoints QR Codes
            // IMPORTANT: QR codes are sorted by waypoint ID (not sequence) for stability
            // This means deleting/adding waypoints doesn't change existing QR codes
            if (course.waypoints) {
                // Sort by ID to ensure consistent order
                const sortedWaypoints = [...course.waypoints].sort((a, b) => a.id - b.id);
                
                sortedWaypoints.forEach((wp) => {
                    const wpQRData = {
                        type: 'WAYPOINT',
                        courseId: course.id,
                        courseName: course.name,
                        waypointId: wp.id,  // STABLE unique ID - never changes!
                        waypointName: wp.name,
                        courseCreated: courseTimestamp  // FIXED timestamp
                        // NOTE: No 'sequence' field! Order doesn't matter for QR codes.
                        // Students scan in any order they want during the course.
                    };
                    qrCodes.push({
                        label: wp.name,
                        displayLabel: wp.name,
                        data: JSON.stringify(wpQRData),
                        color: '#000000'
                    });
                });
            }

            // Start Point - END QR Code
            const endQRData = {
                type: 'END_COURSE',
                courseId: course.id,
                courseName: course.name,
                pointName: course.startPoint?.name || 'Arrivee',
                courseCreated: courseTimestamp  // FIXED timestamp
            };
            qrCodes.push({
                label: `ARRIVEE - FIN DU PARCOURS`,
                displayLabel: `Arrivee - FIN`,
                data: JSON.stringify(endQRData),
                color: '#000000'
            });

            // Generate QR codes
            content.innerHTML = qrCodes.map((qr, idx) => `
                <div class="qr-code-item">
                    <h4 style="color: #000000">${qr.displayLabel || qr.label}</h4>
                    <div id="qr-container-${idx}" style="display: flex; justify-content: center;"></div>
                </div>
            `).join('');

            // Render QR codes using QRCode constructor (qrcodejs library)
            qrCodes.forEach((qr, idx) => {
                const container = document.getElementById(`qr-container-${idx}`);
                new QRCode(container, {
                    text: qr.data,
                    width: 180,
                    height: 180,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            });

            window.currentCourseQRCodes = { course, qrCodes };
        }

        function downloadAllQRCodes() {
            if (!window.currentCourseQRCodes) return;
            
            // Check if jsPDF library is loaded
            if (typeof window.jspdf === 'undefined') {
                alert('Le g√©n√©rateur PDF se charge... Veuillez r√©essayer dans un instant.');
                return;
            }

            const { course, qrCodes } = window.currentCourseQRCodes;
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('portrait', 'mm', 'a4');

            qrCodes.forEach((qr, idx) => {
                // Add new page for each QR code (except first)
                if (idx > 0) {
                    pdf.addPage();
                }

                // QRCode library creates an img inside the container
                const container = document.getElementById(`qr-container-${idx}`);
                const img = container ? container.querySelector('img') : null;
                
                if (img) {
                    // Page title at top
                    pdf.setFontSize(24);
                    pdf.setTextColor(0, 0, 0);
                    const titleText = `Parcours: ${course.name}`;
                    const titleWidth = pdf.getTextWidth(titleText);
                    pdf.text(titleText, (210 - titleWidth) / 2, 20);
                    
                    // Large QR code centered on page (150x150mm)
                    const qrSize = 150;
                    const qrX = (210 - qrSize) / 2; // Center horizontally (A4 width = 210mm)
                    const qrY = 60; // Below the title
                    pdf.addImage(img.src, 'PNG', qrX, qrY, qrSize, qrSize);
                    
                    // QR code label at bottom (easy to cut off)
                    pdf.setFontSize(18);
                    pdf.setTextColor(0, 0, 0);
                    const labelWidth = pdf.getTextWidth(qr.label);
                    pdf.text(qr.label, (210 - labelWidth) / 2, 270);
                }
            });

            pdf.save(`QR_Codes_${course.name.replace(/[^a-z0-9]/gi, '_')}.pdf`);
        }

        function closeQRModal() {
            document.getElementById('qrCodesModal').style.display = 'none';
        }

        async function deleteCourse(index) {
            const course = window.manageCourses[index];
            if (confirm(`Supprimer le parcours "${course.name}" ?\n\nCette action est irr√©versible.`)) {
                window.manageCourses.splice(index, 1);
                // Would need API endpoint to save
                alert('Parcours supprim√© ! (Impl√©mentation API n√©cessaire)');
                displayCourses();
            }
        }

        // Close modals on outside click
        window.onclick = function(event) {
            const editModal = document.getElementById('editCourseModal');
            const qrModal = document.getElementById('qrCodesModal');
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === qrModal) {
                closeQRModal();
            }
        };
    </script>
    
    <!-- Load libraries from local assets (no CDN needed) -->
    <script src="{{ asset('assets/js/qrcode.min.js') }}" onload="window.qrCodeLibraryLoaded = true; console.log('QRCode library loaded from local assets');"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" data-turbo-track="reload" async onload="window.jspdfLibraryLoaded = true; console.log('jsPDF library loaded');"></script>
{% endblock %}
{% endblock %}
